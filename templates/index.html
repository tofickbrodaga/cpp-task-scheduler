<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>C++ project</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>

<div class="container">
    <h1>‚è±Ô∏è C++ –ü–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ –∏ —Ç—Ä–µ–∫–µ—Ä –∑–∞–¥–∞—á</h1>
    
    <div class="input-group">
        <input type="text" id="taskInput" placeholder="–ù–æ–≤–∞—è –∑–∞–¥–∞—á–∞... (Enter)">
        <button class="btn-add" onclick="addTask()">Add</button>
    </div>

    <div id="taskList"></div>

    <button class="btn-clear" onclick="clearCompleted()">üóë –£–¥–∞–ª–∏—Ç—å –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—ã–µ</button>
</div>

<script>
    let tasksData = [];

    function formatTime(seconds) {
        const h = Math.floor(seconds / 3600).toString().padStart(2, '0');
        const m = Math.floor((seconds % 3600) / 60).toString().padStart(2, '0');
        const s = Math.floor(seconds % 60).toString().padStart(2, '0');
        return `${h}:${m}:${s}`;
    }

    async function loadTasks() {
        const res = await fetch('/api/tasks');
        tasksData = await res.json();
        renderTasks();
    }

    function renderTasks() {
        const list = document.getElementById('taskList');
        list.innerHTML = '';
        
        tasksData.forEach(task => {
            const isRunning = task.start_timestamp > 0;
            const div = document.createElement('div');
            div.className = `task status-${task.status} ${isRunning ? 'running' : ''}`;

            const safeTitle = task.title.replace(/'/g, "\\'").replace(/"/g, '&quot;');

            let currentSeconds = task.time_spent;
            if (isRunning) {
                const now = Math.floor(Date.now() / 1000);
                currentSeconds += (now - task.start_timestamp);
            }

            div.innerHTML = `
                <div class="task-info">
                    <span class="task-title" onclick="editTask(${task.id}, '${safeTitle}')">${task.title}</span>
                    <div class="task-meta">
                        <span class="timer-badge" id="timer-${task.id}">${formatTime(currentSeconds)}</span>
                    </div>
                </div>

                <select class="status-select" onchange="changeStatus(${task.id}, this.value)">
                    <option value="todo" ${task.status === 'todo' ? 'selected' : ''}>To Do</option>
                    <option value="in_progress" ${task.status === 'in_progress' ? 'selected' : ''}>In Progress</option>
                    <option value="done" ${task.status === 'done' ? 'selected' : ''}>Done</option>
                </select>

                <div class="actions">
                    <button class="icon-btn" onclick="toggleTimer(${task.id})" title="${isRunning ? 'Pause' : 'Start'}">
                        ${isRunning ? '‚è∏Ô∏è' : '‚ñ∂Ô∏è'}
                    </button>
                    <button class="icon-btn" onclick="deleteTask(${task.id})">‚ùå</button>
                </div>
            `;
            list.appendChild(div);
        });
    }

    setInterval(() => {
        const now = Math.floor(Date.now() / 1000);
        tasksData.forEach(task => {
            if (task.start_timestamp > 0) {
                const total = task.time_spent + (now - task.start_timestamp);
                const el = document.getElementById(`timer-${task.id}`);
                if (el) el.innerText = formatTime(total);
            }
        });
    }, 1000);

    document.getElementById("taskInput").addEventListener("keyup", function(event) {
        if (event.key === "Enter") addTask();
    });

    async function addTask() {
        const input = document.getElementById('taskInput');
        if(!input.value.trim()) return;
        await fetch('/api/tasks', {
            method: 'POST',
            body: JSON.stringify({title: input.value})
        });
        input.value = '';
        loadTasks();
    }

    async function changeStatus(id, newStatus) {
        await fetch(`/api/tasks/${id}/status`, {
            method: 'PUT',
            body: JSON.stringify({status: newStatus})
        });
        loadTasks();
    }

    async function toggleTimer(id) {
        await fetch(`/api/tasks/${id}/timer`, { method: 'POST' });
        loadTasks();
    }

    async function deleteTask(id) {
        if(!confirm('–£–¥–∞–ª–∏—Ç—å?')) return;
        await fetch(`/api/tasks/${id}`, { method: 'DELETE' });
        loadTasks();
    }

    async function editTask(id, oldTitle) {
        const newTitle = prompt("–ò–∑–º–µ–Ω–∏—Ç—å –Ω–∞–∑–≤–∞–Ω–∏–µ:", oldTitle);
        if (newTitle && newTitle.trim()) {
            await fetch(`/api/tasks/${id}`, {
                method: 'PUT',
                body: JSON.stringify({title: newTitle})
            });
            loadTasks();
        }
    }

    async function clearCompleted() {
        if(!confirm('–£–¥–∞–ª–∏—Ç—å –≤—Å–µ Done –∑–∞–¥–∞—á–∏?')) return;
        await fetch('/api/tasks/completed', { method: 'DELETE' });
        loadTasks();
    }

    loadTasks();
</script>

</body>
</html>